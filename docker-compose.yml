# Docker Compose / Docker Swarm Stack file for Liturgia System
# Production deployment with PostgreSQL and Apache
# All environment variables are configured directly in the stack
version: '3.8'

services:
  app:
    image: ghcr.io/josemaeldon/liturgia:latest
    working_dir: /var/www

    networks:
      - liturgianet

    volumes:
      - storage-data:/var/www/storage
      - cache-data:/var/www/bootstrap/cache

    environment:
      APP_NAME: "Liturgia Cat√≥lica"
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: https://liturgia.santaluzia.org

      # Database configuration - CHANGE THESE VALUES
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: liturgia_db
      DB_USERNAME: postgres
      DB_PASSWORD: "liturgia_db_password_2024_change_this"  # CHANGE THIS PASSWORD

      # Redis configuration (optional, for caching)
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Flask secret key - CHANGE THIS
      SECRET_KEY: "your-super-secret-key-here-change-this-to-random-string"  # CHANGE THIS KEY
      FLASK_ENV: production
      FLASK_DEBUG: "false"
      UPLOAD_FOLDER: /var/www/storage

    deploy:
      replicas: 2
      placement:
        constraints:
          - node.role == manager

      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first

      rollback_config:
        parallelism: 1
        delay: 10s

      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

      labels:
        - traefik.enable=true
        - traefik.docker.network=liturgianet

        - traefik.http.routers.liturgia.rule=Host(`liturgia.santaluzia.org`)
        - traefik.http.routers.liturgia.entrypoints=websecure
        - traefik.http.routers.liturgia.tls.certresolver=letsencryptresolver
        - traefik.http.services.liturgia.loadbalancer.server.port=80

        - traefik.http.middlewares.liturgia-upload.buffering.maxRequestBodyBytes=104857600
        - traefik.http.middlewares.liturgia-upload.buffering.memRequestBodyBytes=2097152
        - traefik.http.routers.liturgia.middlewares=liturgia-upload

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: liturgia_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "liturgia_db_password_2024_change_this"  # MUST MATCH DB_PASSWORD ABOVE
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      - postgres-data:/var/lib/postgresql/data

    networks:
      - liturgianet

    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes

    volumes:
      - redis-data:/data

    networks:
      - liturgianet

    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager

      restart_policy:
        condition: on-failure

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  cache-data:
    driver: local
  storage-data:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local

networks:
  liturgianet:
    driver: overlay
    attachable: true
